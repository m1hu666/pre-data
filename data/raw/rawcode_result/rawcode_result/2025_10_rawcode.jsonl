{"patches_id": 1, "files_id": 1, "language": "java", "raw_url": "https://github.com/xmlunit/xmlunit/raw/b81d48b71dfd2868bdfc30a3e17ff973f32bc15b/xmlunit-core%2Fsrc%2Fmain%2Fjava%2Forg%2Fxmlunit%2Futil%2FTransformerFactoryConfigurer.java", "raw_code": "/*\n  This file is licensed to You under the Apache License, Version 2.0\n  (the \"License\"); you may not use this file except in compliance with\n  the License.  You may obtain a copy of the License at\n\n  http://www.apache.org/licenses/LICENSE-2.0\n\n  Unless required by applicable law or agreed to in writing, software\n  distributed under the License is distributed on an \"AS IS\" BASIS,\n  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  See the License for the specific language governing permissions and\n  limitations under the License.\n*/\npackage org.xmlunit.util;\n\nimport java.util.Collections;\nimport java.util.HashMap;\nimport java.util.Map;\nimport javax.xml.XMLConstants;\nimport javax.xml.transform.TransformerConfigurationException;\nimport javax.xml.transform.TransformerFactory;\n\nimport org.xmlunit.ConfigurationException;\n\n/**\n * Configures TransformerFactories.\n *\n * @since XMLUnit 2.6.0\n */\npublic class TransformerFactoryConfigurer {\n\n    private final Map<String, Object> attributes, safeAttributes;\n    private final Map<String, Boolean> features, safeFeatures;\n\n    private TransformerFactoryConfigurer(Map<String, Object> attributes, Map<String, Object> safeAttributes,\n            Map<String, Boolean> features, Map<String, Boolean> safeFeatures) {\n        this.attributes = attributes;\n        this.safeAttributes = safeAttributes;\n        this.features = features;\n        this.safeFeatures = safeFeatures;\n    }\n\n    /**\n     * Applies the current configuration.\n     *\n     * @param factory the factory to configure\n     * @return the configured factory\n     * @throws ConfigurationException if any of the attributes or\n     * features set is not supported.\n     */\n    public TransformerFactory configure(TransformerFactory factory) {\n        for (Map.Entry<String, Object> attr : attributes.entrySet()) {\n            try {\n                factory.setAttribute(attr.getKey(), attr.getValue());\n            } catch (IllegalArgumentException ex) {\n                throw new ConfigurationException(\"Error setting attribute \" + attr.getKey(), ex);\n            }\n        }\n        for (Map.Entry<String, Object> attr : safeAttributes.entrySet()) {\n            try {\n                factory.setAttribute(attr.getKey(), attr.getValue());\n            } catch (IllegalArgumentException ex) {\n                // swallow\n            }\n        }\n        for (Map.Entry<String, Boolean> feat : features.entrySet()) {\n            try {\n                factory.setFeature(feat.getKey(), feat.getValue());\n            } catch (TransformerConfigurationException ex) {\n                throw new ConfigurationException(\"Error setting feature \" + feat.getKey(), ex);\n            }\n        }\n        for (Map.Entry<String, Boolean> feat : safeFeatures.entrySet()) {\n            try {\n                factory.setFeature(feat.getKey(), feat.getValue());\n            } catch (TransformerConfigurationException ex) {\n                // swallow\n            }\n        }\n        return factory;\n    }\n\n    /**\n     * Creates a builder for TransformerFactoryConfigurers.\n     * @return a fresh builder\n     */\n    public static Builder builder() {\n        return new Builder();\n    }\n\n    /**\n     * The default instance which disables DTD loading and extension functions but still\n     * allows loading of external stylesheets.\n     */\n    public static final TransformerFactoryConfigurer Default = builder()\n        .withDTDLoadingDisabled()\n        .withExtensionFunctionsDisabled()\n        .build();\n\n    /**\n     * The instance which enables secure processing thus disables all external access as well as execution of extension\n     * functions.\n     *\n     * @since XMLUnit 2.10.0\n     */\n    public static final TransformerFactoryConfigurer SecureProcessing = builder()\n        .withSecureProcessingEnabled()\n        .build();\n\n    /**\n     * The instance which disables DTD loading as well as loading of\n     * external stylesheets or extension functions.\n     */\n    public static final TransformerFactoryConfigurer NoExternalAccess = builder()\n        .withDTDLoadingDisabled()\n        .withExternalStylesheetLoadingDisabled()\n        .withExtensionFunctionsDisabled()\n        .build();\n\n    /**\n     * The instance which disables DTD loading but still\n     * allows loading of external stylesheets and extension functions.\n     *\n     * @since XMLUnit 2.10.0\n     */\n    public static final TransformerFactoryConfigurer NoDtdButExtensionFunctions = builder()\n        .withDTDLoadingDisabled()\n        .build();\n\n    /**\n     * The instance which disables DTD loading as well as loading of\n     * external stylesheets but allows extension functions.\n     *\n     * @since XMLUnit 2.10.0\n     */\n    public static final TransformerFactoryConfigurer NoExternalAccessButExtensionFunctions = builder()\n        .withDTDLoadingDisabled()\n        .withExternalStylesheetLoadingDisabled()\n        .build();\n\n    /**\n     * Builder for a TransformerFactoryConfigurer.\n     *\n     * @since XMLUnit 2.6.0\n     */\n    public static class Builder {\n        private final Map<String, Object> attributes = new HashMap<String, Object>();\n        private final Map<String, Object> safeAttributes = new HashMap<String, Object>();\n        private final Map<String, Boolean> features = new HashMap<String, Boolean>();\n        private final Map<String, Boolean> safeFeatures = new HashMap<String, Boolean>();\n\n        /**\n         * Builds a TransformerFactoryConfigurer.\n         * @return the configurer\n         */\n        public TransformerFactoryConfigurer build() {\n            return new TransformerFactoryConfigurer(Collections.unmodifiableMap(attributes),\n                Collections.unmodifiableMap(safeAttributes), Collections.unmodifiableMap(features),\n                Collections.unmodifiableMap(safeFeatures));\n        }\n\n        /**\n         * Configures the factory with the given attribute, causes an\n         * exception in {@link #configure} if the attribute is not\n         * supported.\n         * @param key key of the attribute to be set\n         * @param value value for the attribute to set\n         * @return this\n         */\n        public Builder withAttribute(String key, Object value) {\n            attributes.put(key, value);\n            return this;\n        }\n\n        /**\n         * Configures the factory with the given attribute if it is\n         * supported.\n         * @param key key of the attribute to be set\n         * @param value value for the attribute to set\n         * @return this\n         */\n        public Builder withSafeAttribute(String key, Object value) {\n            safeAttributes.put(key, value);\n            return this;\n        }\n\n        /**\n         * Configures the factory with the given feature, causes an\n         * exception in {@link #configure} if the feature is not\n         * supported.\n         * @param key key of the feature to be set\n         * @param value value for the feature to set\n         * @return this\n         */\n        public Builder withFeature(String key, boolean value) {\n            features.put(key, value);\n            return this;\n        }\n\n        /**\n         * Configures the factory with the given feature if it is\n         * supported.\n         * @param key key of the feature to be set\n         * @param value value for the feature to set\n         * @return this\n         */\n        public Builder withSafeFeature(String key, boolean value) {\n            safeFeatures.put(key, value);\n            return this;\n        }\n\n        /**\n         * Configures the factory to not load any external DTDs.\n         * @return this\n         */\n        public Builder withDTDLoadingDisabled() {\n            // XMLConstants.ACCESS_EXTERNAL_DTD is not available in Java 6\n            return withSafeAttribute(\"http://javax.xml.XMLConstants/property/accessExternalDTD\", \"\");\n        }\n\n        /**\n         * Configures the factory to not parse any DTDs.\n         * @return this\n         */\n        public Builder withExternalStylesheetLoadingDisabled() {\n            // XMLConstants.ACCESS_EXTERNAL_STYLESHEET is not available in Java 6\n            return withSafeAttribute(\"http://javax.xml.XMLConstants/property/accessExternalStylesheet\", \"\");\n        }\n\n        /**\n         * Configures the factory to not enable extension functions.\n         * @return this\n         *\n         * @since XMLUnit 2.10.0\n         */\n        public Builder withExtensionFunctionsDisabled() {\n            return withSafeAttribute(\"jdk.xml.enableExtensionFunctions\", \"false\");\n        }\n\n        /**\n         * Configures the factory to enable secure processing which disables all external access as well as execution of\n         * extension functions.\n         * @return this\n         *\n         * @since XMLUnit 2.10.0\n         */\n        public Builder withSecureProcessingEnabled() {\n            return withFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);\n        }\n\n    }\n}\n", "patch": "@@ -16,6 +16,7 @@\n import java.util.Collections;\n import java.util.HashMap;\n import java.util.Map;\n+import javax.xml.XMLConstants;\n import javax.xml.transform.TransformerConfigurationException;\n import javax.xml.transform.TransformerFactory;\n \n@@ -88,18 +89,51 @@ public static Builder builder() {\n     }\n \n     /**\n-     * The default instance which disables DTD loading but still\n+     * The default instance which disables DTD loading and extension functions but still\n      * allows loading of external stylesheets.\n      */\n     public static final TransformerFactoryConfigurer Default = builder()\n         .withDTDLoadingDisabled()\n+        .withExtensionFunctionsDisabled()\n+        .build();\n+\n+    /**\n+     * The instance which enables secure processing thus disables all external access as well as execution of extension\n+     * functions.\n+     *\n+     * @since XMLUnit 2.10.0\n+     */\n+    public static final TransformerFactoryConfigurer SecureProcessing = builder()\n+        .withSecureProcessingEnabled()\n         .build();\n \n     /**\n      * The instance which disables DTD loading as well as loading of\n-     * external stylesheets.\n+     * external stylesheets or extension functions.\n      */\n     public static final TransformerFactoryConfigurer NoExternalAccess = builder()\n+        .withDTDLoadingDisabled()\n+        .withExternalStylesheetLoadingDisabled()\n+        .withExtensionFunctionsDisabled()\n+        .build();\n+\n+    /**\n+     * The instance which disables DTD loading but still\n+     * allows loading of external stylesheets and extension functions.\n+     *\n+     * @since XMLUnit 2.10.0\n+     */\n+    public static final TransformerFactoryConfigurer NoDtdButExtensionFunctions = builder()\n+        .withDTDLoadingDisabled()\n+        .build();\n+\n+    /**\n+     * The instance which disables DTD loading as well as loading of\n+     * external stylesheets but allows extension functions.\n+     *\n+     * @since XMLUnit 2.10.0\n+     */\n+    public static final TransformerFactoryConfigurer NoExternalAccessButExtensionFunctions = builder()\n         .withDTDLoadingDisabled()\n         .withExternalStylesheetLoadingDisabled()\n         .build();\n@@ -192,5 +226,27 @@ public Builder withExternalStylesheetLoadingDisabled() {\n             // XMLConstants.ACCESS_EXTERNAL_STYLESHEET is not available in Java 6\n             return withSafeAttribute(\"http://javax.xml.XMLConstants/property/accessExternalStylesheet\", \"\");\n         }\n+\n+        /**\n+         * Configures the factory to not enable extension functions.\n+         * @return this\n+         *\n+         * @since XMLUnit 2.10.0\n+         */\n+        public Builder withExtensionFunctionsDisabled() {\n+            return withSafeAttribute(\"jdk.xml.enableExtensionFunctions\", \"false\");\n+        }\n+\n+        /**\n+         * Configures the factory to enable secure processing which disables all external access as well as execution of\n+         * extension functions.\n+         * @return this\n+         *\n+         * @since XMLUnit 2.10.0\n+         */\n+        public Builder withSecureProcessingEnabled() {\n+            return withFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);\n+        }\n+\n     }\n }"}
